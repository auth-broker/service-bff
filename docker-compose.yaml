services:
  # ────────────────────────────────
  # BFF Service
  # ────────────────────────────────
  ab-bff-service:
    container_name: ab-bff-service
    build:
      context: .
    volumes:
      - ./src:/package/src
      - ./tests:/package/tests
    ports:
      - "9090:80"
    environment:
      LOGGING_CONFIG_LEVEL: "${LOGGING_CONFIG_LEVEL:-INFO}"
      LOGGING_CONFIG_NAMESPACES: '${LOGGING_CONFIG_NAMESPACES:-["", "uvicorn"]}'
      DATABASE_TYPE: SQL_ALCHEMY
      # Use its own DB
      DATABASE_SQL_ALCHEMY_URL: postgresql+asyncpg://user:password@auth-broker-postgres:5432/ab_bff_service
      ALEMBIC_AUTO_MIGRATE_DB_URL: postgresql+psycopg://user:password@auth-broker-postgres:5432/ab_bff_service
      ALEMBIC_AUTO_MIGRATE_INI_PATH: /package/alembic.ini
      ALEMBIC_AUTO_MIGRATE_SCRIPT_LOCATION: /package/alembic
      ALEMBIC_AUTO_MIGRATE_AUTOGENERATE: "${ALEMBIC_AUTO_MIGRATE_AUTOGENERATE:-true}"
      ALEMBIC_AUTO_MIGRATE_MIGRATION_MESSAGE: "${ALEMBIC_AUTO_MIGRATE_MIGRATION_MESSAGE:-autogenerated at startup}"
      ALEMBIC_AUTO_MIGRATE_COMPARE_TYPE: "${ALEMBIC_AUTO_MIGRATE_COMPARE_TYPE:-true}"
      ALEMBIC_AUTO_MIGRATE_COMPARE_SERVER_DEFAULT: "${ALEMBIC_AUTO_MIGRATE_COMPARE_SERVER_DEFAULT:-true}"
      ALEMBIC_AUTO_MIGRATE_INCLUDE_SCHEMAS: "${ALEMBIC_AUTO_MIGRATE_INCLUDE_SCHEMAS:-false}"
    depends_on:
      postgres:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully
    networks:
      - auth-broker-bff

  # ────────────────────────────────
  # Auth Broker Micro-services
  # ────────────────────────────────
  ab-user-service:
    container_name: ab-user-service
    image: mattcoulter7/ab-user-service:latest
    environment:
      LOGGING_CONFIG_LEVEL: "${LOGGING_CONFIG_LEVEL:-INFO}"
      LOGGING_CONFIG_NAMESPACES: '${LOGGING_CONFIG_NAMESPACES:-["", "uvicorn"]}'
      DATABASE_TYPE: SQL_ALCHEMY
      # Use its own DB
      DATABASE_SQL_ALCHEMY_URL: postgresql+asyncpg://user:password@auth-broker-postgres:5432/ab_user_service
      ALEMBIC_AUTO_MIGRATE_DB_URL: postgresql+psycopg://user:password@auth-broker-postgres:5432/ab_user_service
      ALEMBIC_AUTO_MIGRATE_INI_PATH: /package/alembic.ini
      ALEMBIC_AUTO_MIGRATE_SCRIPT_LOCATION: /package/alembic
      ALEMBIC_AUTO_MIGRATE_AUTOGENERATE: "${ALEMBIC_AUTO_MIGRATE_AUTOGENERATE:-true}"
      ALEMBIC_AUTO_MIGRATE_MIGRATION_MESSAGE: "${ALEMBIC_AUTO_MIGRATE_MIGRATION_MESSAGE:-autogenerated at startup}"
      ALEMBIC_AUTO_MIGRATE_COMPARE_TYPE: "${ALEMBIC_AUTO_MIGRATE_COMPARE_TYPE:-true}"
      ALEMBIC_AUTO_MIGRATE_COMPARE_SERVER_DEFAULT: "${ALEMBIC_AUTO_MIGRATE_COMPARE_SERVER_DEFAULT:-true}"
      ALEMBIC_AUTO_MIGRATE_INCLUDE_SCHEMAS: "${ALEMBIC_AUTO_MIGRATE_INCLUDE_SCHEMAS:-false}"
    depends_on:
      postgres:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully
    ports:
      - "9002:80"
    networks:
      - auth-broker-bff

  ab-token-validator-service:
    container_name: ab-token-validator-service
    image: mattcoulter7/ab-token-validator-service:latest
    environment:
      LOGGING_CONFIG_LEVEL: "${LOGGING_CONFIG_LEVEL:-INFO}"
      LOGGING_CONFIG_NAMESPACES: '${LOGGING_CONFIG_NAMESPACES:-["", "uvicorn"]}'
      TOKEN_VALIDATOR_TYPE: "${TOKEN_VALIDATOR_TYPE:-}"
      TOKEN_VALIDATOR_OIDC_ISSUER: "${TOKEN_VALIDATOR_OIDC_ISSUER:-}"
      TOKEN_VALIDATOR_OIDC_JWKS_URI: "${TOKEN_VALIDATOR_OIDC_JWKS_URI:-}"
      TOKEN_VALIDATOR_OIDC_AUDIENCE: "${TOKEN_VALIDATOR_OIDC_AUDIENCE:-}"
      TOKEN_VALIDATOR_OIDC_ALGORITHMS: '${TOKEN_VALIDATOR_OIDC_ALGORITHMS:-[]}'
    ports:
      - "9001:80"
    networks:
      - auth-broker-bff

  ab-auth-client-service:
    container_name: ab-auth-client-service
    image: mattcoulter7/ab-auth-client-service:latest
    environment:
      LOGGING_CONFIG_LEVEL: "${LOGGING_CONFIG_LEVEL:-INFO}"
      LOGGING_CONFIG_NAMESPACES: '${LOGGING_CONFIG_NAMESPACES:-["", "uvicorn"]}'
      O_AUTH2_CLIENT_TYPE: "${O_AUTH2_CLIENT_TYPE:-}"
      O_AUTH2_CLIENT_STANDARD_CONFIG_CLIENT_ID: "${O_AUTH2_CLIENT_STANDARD_CONFIG_CLIENT_ID:-}"
      O_AUTH2_CLIENT_STANDARD_CONFIG_CLIENT_SECRET: "${O_AUTH2_CLIENT_STANDARD_CONFIG_CLIENT_SECRET:-}"
      O_AUTH2_CLIENT_STANDARD_CONFIG_REDIRECT_URI: "${O_AUTH2_CLIENT_STANDARD_CONFIG_REDIRECT_URI:-}"
      O_AUTH2_CLIENT_STANDARD_CONFIG_AUTHORIZE_URL: "${O_AUTH2_CLIENT_STANDARD_CONFIG_AUTHORIZE_URL:-}"
      O_AUTH2_CLIENT_STANDARD_CONFIG_TOKEN_URL: "${O_AUTH2_CLIENT_STANDARD_CONFIG_TOKEN_URL:-}"
      CACHE_TYPE: "${CACHE_TYPE:-}"
      CACHE_NAMESPACE_NAMESPACE: "${CACHE_NAMESPACE_NAMESPACE:-}"
    ports:
      - "9000:80"
    networks:
      - auth-broker-bff

  # ────────────────────────────────
  # Postgres (shared)
  # ────────────────────────────────
  postgres:
    container_name: auth-broker-postgres
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: bootstrap_only   # created automatically; others via db-init
    ports:
      - "95432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d postgres -h 127.0.0.1"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - auth-broker-bff

  # ────────────────────────────────
  # DB init job: create per-service DBs
  # ────────────────────────────────
  db-init:
    container_name: ab-db-init
    image: postgres:16-alpine
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGPASSWORD: password
      PGUSER: user
    entrypoint: ["/bin/sh","-c"]
    command: >
      "
      for DB in ab_user_service ab_bff_service; do
        psql -h auth-broker-postgres -U $$PGUSER -tc \"SELECT 1 FROM pg_database WHERE datname='$$DB'\" |
        grep -q 1 || createdb -h auth-broker-postgres -U $$PGUSER \"$$DB\";
      done
      "
    networks:
      - auth-broker-bff
    restart: "no"

networks:
  auth-broker-bff:
    external: true

volumes:
  pgdata:
