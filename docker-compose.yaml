services:
  # ────────────────────────────────
  # BFF Service
  # ────────────────────────────────
  ab-bff-service:
    container_name: ab-bff-service
    build:
      context: .
    volumes:
      # Dev mounts you already had
      - ./src:/package/src
      - ./tests:/package/tests
      # Persist SQLite DB and Alembic scripts generated at runtime
      - ab_bff_data:/package/data
      - ab_bff_alembic:/package/alembic
    ports:
      - "9090:80"
    environment:
      LOGGING_CONFIG_LEVEL: "${LOGGING_CONFIG_LEVEL:-INFO}"
      LOGGING_CONFIG_NAMESPACES: '${LOGGING_CONFIG_NAMESPACES:-["", "uvicorn"]}'
      DATABASE_TYPE: SQL_ALCHEMY
      # Absolute path inside container ⇒ 4 slashes after scheme
      DATABASE_SQL_ALCHEMY_URL: sqlite+aiosqlite:////package/data/data.db
      ALEMBIC_AUTO_MIGRATE_DB_URL: sqlite:////package/data/data.db
      ALEMBIC_AUTO_MIGRATE_INI_PATH: /package/alembic.ini
      ALEMBIC_AUTO_MIGRATE_SCRIPT_LOCATION: /package/alembic
      ALEMBIC_AUTO_MIGRATE_AUTOGENERATE: "true"
      ALEMBIC_AUTO_MIGRATE_MIGRATION_MESSAGE: autogenerated at startup
      ALEMBIC_AUTO_MIGRATE_COMPARE_TYPE: "true"
      ALEMBIC_AUTO_MIGRATE_COMPARE_SERVER_DEFAULT: "true"
      ALEMBIC_AUTO_MIGRATE_INCLUDE_SCHEMAS: "false"
    networks:
      - auth-broker-bff
    restart: unless-stopped


  # ────────────────────────────────
  # Auth Client (no DB)
  # ────────────────────────────────
  ab-auth-client-service:
    container_name: ab-auth-client-service
    image: mattcoulter7/ab-auth-client-service:latest
    environment:
      LOGGING_CONFIG_LEVEL: "INFO"
      LOGGING_CONFIG_NAMESPACES: '["", "uvicorn"]'
      O_AUTH2_CLIENT_TYPE: STANDARD
      O_AUTH2_CLIENT_STANDARD_CONFIG_CLIENT_ID: cUdr3ZNSREvqdY4iC5ZiR8NSNuNXb0y7liy1tkB0
      O_AUTH2_CLIENT_STANDARD_CONFIG_CLIENT_SECRET: eZ0OqJYhjOwpMpew0xlX80VbqWFw0Ty0QBJGTQQHogLoCKexctwGzgorn2W2OqzwBMs8tph6JPoJ6yK821DamJyd0MxMBgWAnNWfRh3yMBn9aZFQCo4VCcKXB2PmXEFC
      O_AUTH2_CLIENT_STANDARD_CONFIG_REDIRECT_URI: http://localhost:9000/callback
      O_AUTH2_CLIENT_STANDARD_CONFIG_AUTHORIZE_URL: https://authentik.matthewcoulter.dev/application/o/authorize/
      O_AUTH2_CLIENT_STANDARD_CONFIG_TOKEN_URL: https://authentik.matthewcoulter.dev/application/o/token/
      CACHE_TYPE: INMEMORY
      CACHE_NAMESPACE_NAMESPACE: auth_client
    ports:
      - "9000:80"
    networks:
      - auth-broker-bff
    restart: unless-stopped

  # ────────────────────────────────
  # Token Validator (no DB)
  # ────────────────────────────────
  ab-token-validator-service:
    container_name: ab-token-validator-service
    image: mattcoulter7/ab-token-validator-service:latest
    environment:
      LOGGING_CONFIG_LEVEL: "INFO"
      LOGGING_CONFIG_NAMESPACES: '["", "uvicorn"]'
      TOKEN_VALIDATOR_TYPE: OIDC
      TOKEN_VALIDATOR_OIDC_ISSUER: https://authentik.matthewcoulter.dev/application/o/oauth2-broker/
      TOKEN_VALIDATOR_OIDC_JWKS_URI: https://authentik.matthewcoulter.dev/application/o/oauth2-broker/jwks/
      TOKEN_VALIDATOR_OIDC_AUDIENCE: cUdr3ZNSREvqdY4iC5ZiR8NSNuNXb0y7liy1tkB0
      TOKEN_VALIDATOR_OIDC_ALGORITHMS: '["RS256"]'
    ports:
      - "9001:80"
    networks:
      - auth-broker-bff
    restart: unless-stopped

  # ────────────────────────────────
  # User Service (SQLite + persistent data & alembic)
  # ────────────────────────────────
  ab-user-service:
    container_name: ab-user-service
    image: mattcoulter7/ab-user-service:latest
    volumes:
      - ab_user_data:/package/data
      - ab_user_alembic:/package/alembic
    environment:
      LOGGING_CONFIG_LEVEL: "INFO"
      LOGGING_CONFIG_NAMESPACES: '["", "uvicorn"]'
      DATABASE_TYPE: SQL_ALCHEMY
      DATABASE_SQL_ALCHEMY_URL: sqlite+aiosqlite:////package/data/data.db
      ALEMBIC_AUTO_MIGRATE_DB_URL: sqlite:////package/data/data.db
      ALEMBIC_AUTO_MIGRATE_INI_PATH: /package/alembic.ini
      ALEMBIC_AUTO_MIGRATE_SCRIPT_LOCATION: /package/alembic
      ALEMBIC_AUTO_MIGRATE_AUTOGENERATE: "true"
      ALEMBIC_AUTO_MIGRATE_MIGRATION_MESSAGE: autogenerated at startup
      ALEMBIC_AUTO_MIGRATE_COMPARE_TYPE: "true"
      ALEMBIC_AUTO_MIGRATE_COMPARE_SERVER_DEFAULT: "true"
      ALEMBIC_AUTO_MIGRATE_INCLUDE_SCHEMAS: "false"
    ports:
      - "9002:80"
    networks:
      - auth-broker-bff
    restart: unless-stopped

networks:
  auth-broker-bff:
    external: true

volumes:
  # BFF persistence
  ab_bff_data:
  ab_bff_alembic:
  # User-service persistence
  ab_user_data:
  ab_user_alembic:
